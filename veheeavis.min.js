!function(t){"function"==typeof define&&define.amd?define(t):t()}(function(){"use strict";var t,i;t="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0,i=function(){class Ploteeavis{constructor(t){this.container=document.querySelector(t.container),this.data=t.data,this.showGuide=!0===t.showGuide,this.scale=1,this.draggingModule=null,this.dragOffsetX=0,this.dragOffsetY=0,this.startPort=null,this.endPort=null,this.selectedModule=null,this.canvas=document.createElement("canvas"),this.container.appendChild(this.canvas),this.ctx=this.canvas.getContext("2d"),this.dpr=window.devicePixelRatio||1,this.canvas.style.width=this.container.clientWidth+"px",this.canvas.style.height=this.container.clientHeight+"px",this.canvas.width=this.container.clientWidth*this.dpr,this.canvas.height=this.container.clientHeight*this.dpr,this.ctx.scale(this.dpr,this.dpr),this.view={x:0,y:0,zoom:1},this.snapDistance=20,this.snapPort=null,this.contextMenu=this.createContextMenu(),this.container.appendChild(this.contextMenu),this.activeModule=null,this.validateData(this.data),this.addEventListeners(),this.render()}createContextMenu(){const t=document.createElement("div");t.style.cssText="\n      position: absolute;\n      background: white;\n      border: 1px solid #ccc;\n      padding: 5px 0;\n      box-shadow: 2px 2px 5px rgba(0,0,0,0.2);\n      display: none;\n      z-index: 1000;\n    ";const i=void 0;return["Copy","Delete","Add Top Port","Add Left Port","Add Bottom Port","Add Right Port"].forEach(i=>{const e=document.createElement("div");e.textContent=i,e.style.cssText="\n        padding: 5px 20px;\n        cursor: pointer;\n        &:hover { background: #f0f0f0; }\n      ",t.appendChild(e)}),t}render(){if(this.ctx.save(),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.portRects=[],this.ctx.translate(this.view.x*this.dpr,this.view.y*this.dpr),this.ctx.scale(this.view.zoom,this.view.zoom),this.data.modules.forEach(t=>{this.drawModule(t),this.drawPorts(t)}),this.data.modules.every(t=>t.leftArray&&t.rightArray&&t.topArray&&t.bottomArray)&&this.data.connections.forEach(t=>{this.drawConnection(t)}),this.startPort&&this.drawTempConnectionToMouse(this.startPort,this.mouseX,this.mouseY),!0===this.showGuide){const t=this.data.modules.find(t=>"1"===t.id);t&&(this.ctx.save(),this.ctx.strokeStyle="red",this.ctx.lineWidth=2,this.portRects.filter(i=>i.module===t).forEach(t=>{const i=t.x+t.width/2,e=t.y+t.height/2,o=Math.max(t.width,t.height)/2+6;this.ctx.beginPath(),this.ctx.arc(i,e,o,0,2*Math.PI),this.ctx.stroke()}),this.ctx.restore());const i=this.data.modules.find(t=>"2"===t.id);if(t&&i){const e=t=>t.leftArray&&t.leftArray[0]||t.rightArray&&t.rightArray[0]||t.topArray&&t.topArray[0]||t.bottomArray&&t.bottomArray[0],o=e(t),s=e(i);if(o&&s){const e=this.portRects.find(i=>i.port===o&&i.module===t),h=this.portRects.find(t=>t.port===s&&t.module===i);if(e&&h){const t=e.x+e.width/2,i=e.y+e.height/2,o=h.x+h.width/2,s=h.y+h.height/2;this.ctx.save(),this.ctx.strokeStyle="red",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.moveTo(t,i),this.ctx.lineTo(o,s),this.ctx.stroke();const r=Math.atan2(s-i,o-t),n=12;this.ctx.beginPath(),this.ctx.moveTo(o,s),this.ctx.lineTo(o-n*Math.cos(r-Math.PI/8),s-n*Math.sin(r-Math.PI/8)),this.ctx.moveTo(o,s),this.ctx.lineTo(o-n*Math.cos(r+Math.PI/8),s-n*Math.sin(r+Math.PI/8)),this.ctx.stroke(),this.ctx.fillStyle="green",this.ctx.font="16px Arial";const a="Drag from one port to another port.";this.ctx.font="16px Arial";const c=void 0,d=this.ctx.measureText(a).width,l=22,f=(t+o)/2+10,p=(i+s)/2-30;this.ctx.fillStyle="yellow",this.ctx.fillRect(f-6,p-l+6,d+12,l),this.ctx.fillStyle="green",this.ctx.fillText(a,f,p),this.ctx.restore()}}}if(this.data.modules.length>0){const t=this.data.modules[0],{x:i,y:e,width:o,height:s}=t.position;this.ctx.save();const h="Right click on a module for menu.";this.ctx.font="16px Arial";const r=void 0,n=this.ctx.measureText(h).width,a=22,c=i+o+10,d=e+s-10;this.ctx.fillStyle="yellow",this.ctx.fillRect(c-6,d-a+6,n+12,a),this.ctx.fillStyle="green",this.ctx.fillText(h,c,d),this.ctx.restore()}}this.ctx.restore()}drawPorts(t){const{x:i,y:e,width:o,height:s}=t.position,h=t.leftArray,r=s/(h.length+2),n=6,a=i-3;h.forEach((o,s)=>{const h=e+(s+1)*r;this.ctx.fillStyle=`rgb(${100*o.portcolor}, 0, 0)`,this.ctx.fillRect(a,h,6,10),o.offsetX=a-i,o.offsetY=h-e,o.width=6,o.height=10;const n=new Rectangle(a,h,6,10);n.port=o,n.module=t,this.portRects.push(n)});const c=t.rightArray,d=s/(c.length+2),l=6,f=i+o-3;c.forEach((o,s)=>{const h=e+(s+1)*d;this.ctx.fillStyle=`rgb(${100*o.portcolor}, 0, 0)`,this.ctx.fillRect(f,h,6,10),o.offsetX=f-i,o.offsetY=h-e,o.width=6,o.height=10;const r=new Rectangle(f,h,6,10);r.port=o,r.module=t,this.portRects.push(r)});const p=t.topArray,x=o/(p.length+2),u=6,y=e-3;p.forEach((o,s)=>{const h=i+(s+1)*x;this.ctx.fillStyle=`rgb(${100*o.portcolor}, 0, 0)`,this.ctx.fillRect(h,y,10,6),o.offsetX=h-i,o.offsetY=y-e,o.width=10,o.height=6;const r=new Rectangle(h,y,10,6);r.port=o,r.module=t,this.portRects.push(r)});const m=t.bottomArray,g=o/(m.length+2),w=6,v=e+s-3;m.forEach((o,s)=>{const h=i+(s+1)*g;this.ctx.fillStyle=`rgb(${100*o.portcolor}, 0, 0)`,this.ctx.fillRect(h,v,10,6),o.offsetX=h-i,o.offsetY=v-e,o.width=10,o.height=6;const r=new Rectangle(h,v,10,6);r.port=o,r.module=t,this.portRects.push(r)})}validateData(t){const i=t.modules.map(t=>t.name);t.connections.forEach(t=>{if(!i.includes(t.from)||!i.includes(t.to))throw new Error(`Invalid connection: ${t.from} -> ${t.to}`)})}addEventListeners(){this.portRects=[],this.canvas.addEventListener("mousedown",t=>{const i=this.getCanvasCoords(t.clientX,t.clientY),e=this.portRects.find(t=>t.contains(i.x,i.y));e?(this.startPortRect=e,this.startPort=e.port,this.startPort.module=e.module):this.data.modules.forEach(t=>{const{x:e,y:o,width:s,height:h}=t.position;i.x>=e&&i.x<=e+s&&i.y>=o&&i.y<=o+h&&(this.selectedModule=t,this.draggingModule=t,this.dragOffsetX=i.x-e,this.dragOffsetY=i.y-o,this.render())})}),this.canvas.addEventListener("mousemove",t=>{const i=this.getCanvasCoords(t.clientX,t.clientY);this.mouseX=i.x,this.mouseY=i.y;const e=this.portRects.find(t=>t.contains(i.x,i.y));if(this.canvas.style.cursor=e?"pointer":"",this.startPort){const t=this.findNearestPort(i.x,i.y);t?(this.snapPort=t,this.mouseX=t.x+t.width/2,this.mouseY=t.y+t.height/2):this.snapPort=null,this.render()}else this.draggingModule&&(this.draggingModule.position.x=i.x-this.dragOffsetX,this.draggingModule.position.y=i.y-this.dragOffsetY,this.updatePorts(this.draggingModule),this.render())}),this.canvas.addEventListener("mouseup",t=>{if(this.startPort){if(this.snapPort){const t={from:this.startPortRect.module.name,to:this.snapPort.module.name,fromPort:this.startPort.portid,toPort:this.snapPort.port.portid};this.data.connections.push(t),this.drawConnection(t)}this.startPort=null,this.snapPort=null,this.render()}else this.draggingModule&&(this.draggingModule=null,this.render())}),this.canvas.addEventListener("wheel",t=>{if(t.ctrlKey){t.preventDefault();const i=this.canvas.getBoundingClientRect(),e=(t.clientX-i.left)/this.dpr,o=(t.clientY-i.top)/this.dpr,s=this.view.zoom;this.view.zoom*=t.deltaY>0?.9:1.1,this.view.zoom=Math.max(.1,Math.min(this.view.zoom,5)),this.view.x-=(e-this.view.x)*(this.view.zoom/s-1),this.view.y-=(o-this.view.y)*(this.view.zoom/s-1),this.render()}}),this.canvas.addEventListener("contextmenu",t=>{t.preventDefault();const i=this.getCanvasCoords(t.clientX,t.clientY),e=this.data.modules.find(t=>{const{x:e,y:o,width:s,height:h}=t.position;return i.x>=e&&i.x<=e+s&&i.y>=o&&i.y<=o+h});if(e){this.activeModule=e;const t=this.contextMenu.offsetWidth,o=this.contextMenu.offsetHeight,s=window.innerWidth,h=window.innerHeight;let r=i.x,n=i.y;r+t>s&&(r=s-t),n+o>h&&(n=h-o),this.contextMenu.style.display="block",this.contextMenu.style.left=r+"px",this.contextMenu.style.top=n+"px"}}),this.contextMenu.addEventListener("click",t=>{const i=void 0;switch(t.target.textContent){case"Copy":this.copyModule(this.activeModule);break;case"Delete":this.deleteModule(this.activeModule);break;case"Add Top Port":this.addPort(this.activeModule,"top");break;case"Add Left Port":this.addPort(this.activeModule,"left");break;case"Add Bottom Port":this.addPort(this.activeModule,"bottom");break;case"Add Right Port":this.addPort(this.activeModule,"right")}this.contextMenu.style.display="none",this.render()}),document.addEventListener("click",()=>{this.contextMenu.style.display="none"})}copyModule(t){const i=JSON.parse(JSON.stringify(t));i.name=t.name+"_copy",i.position={...t.position,x:t.position.x+50,y:t.position.y+50},this.data.modules.push(i)}deleteModule(t){const i=this.data.modules.indexOf(t);i>-1&&(this.data.modules.splice(i,1),this.data.connections=this.data.connections.filter(i=>i.from!==t.name&&i.to!==t.name))}addPort(t,i){const e={portid:`${i}_${Date.now()}`,portcolor:1};switch(i){case"top":t.topArray.push(e);break;case"left":t.leftArray.push(e);break;case"bottom":t.bottomArray.push(e);break;case"right":t.rightArray.push(e)}}updatePorts(t){const{x:i,y:e,width:o,height:s}=t.position,h=t.leftArray,r=s/(h.length+2),n=6,a=i-3;h.forEach((t,o)=>{const s=e+(o+1)*r;t.offsetX=a-i,t.offsetY=s-e});const c=t.rightArray,d=s/(c.length+2),l=6,f=i+o-3;c.forEach((t,o)=>{const s=e+(o+1)*d;t.offsetX=f-i,t.offsetY=s-e});const p=t.topArray,x=o/(p.length+2),u=6,y=e-3;p.forEach((t,o)=>{const s=i+(o+1)*x;t.offsetX=s-i,t.offsetY=y-e});const m=t.bottomArray,g=o/(m.length+2),w=6,v=e+s-3;m.forEach((t,o)=>{const s=i+(o+1)*g;t.offsetX=s-i,t.offsetY=v-e})}getCanvasCoords(t,i){const e=this.canvas.getBoundingClientRect();return{x:(t-e.left-this.view.x)/this.view.zoom,y:(i-e.top-this.view.y)/this.view.zoom}}drawModule(t){const{x:i,y:e,width:o,height:s,color:h}=t.position;t!==this.selectedModule&&t!==this.draggingModule||(this.ctx.strokeStyle="rgba(179, 177, 177, 0.5)",this.ctx.lineWidth=4,this.ctx.strokeRect(i-4,e-4,o+8,s+8)),this.ctx.fillStyle=h,this.ctx.fillRect(i,e,o,s),this.ctx.strokeStyle="#000",this.ctx.lineWidth=2,this.ctx.strokeRect(i,e,o,s),this.ctx.shadowColor="rgba(0, 0, 0, 0.1)",this.ctx.shadowBlur=10,this.ctx.shadowOffsetX=5,this.ctx.shadowOffsetY=5,this.ctx.fillStyle="#000",this.ctx.font="12px Microsoft YaHei",this.ctx.fillText(t.name,i+10,e+20)}drawPolylineLink(t,i,e,o,s){t.beginPath(),t.moveTo(i,e),t.lineTo(i,e),t.lineTo(o,s),t.lineTo(o,s),t.strokeStyle="black",t.lineWidth=1,t.stroke()}drawPolylineLink_new(t,i,e,o,s,h,r){t.beginPath(),t.moveTo(i,e);const n=void 0;this.calculatePathPoints(i,e,o,s,h,r).forEach(i=>t.lineTo(i.x,i.y)),t.strokeStyle="black",t.lineWidth=1,t.stroke()}calculatePathPoints(t,i,e,o,s,h){const r=[{x:t,y:i}],n=20;switch(s){case"right":r.push({x:t+n,y:i});break;case"left":r.push({x:t-n,y:i});break;case"bottom":r.push({x:t,y:i+n});break;case"top":r.push({x:t,y:i-n})}const a=r[1];let c;switch(h){case"left":c={x:e-n,y:o};break;case"right":c={x:e+n,y:o};break;case"top":c={x:e,y:o-n};break;case"bottom":c={x:e,y:o+n}}return"left"===s||"right"===s?(r.push({x:a.x,y:c.y}),r.push(c)):(r.push({x:c.x,y:a.y}),r.push(c)),r.push({x:e,y:o}),r}drawConnection(t){const i=this.data.modules.find(i=>i.name===t.from),e=this.data.modules.find(i=>i.name===t.to);if(!i||!e)return;const o=(t,i)=>t.leftArray.includes(i)?"left":t.rightArray.includes(i)?"right":t.topArray.includes(i)?"top":t.bottomArray.includes(i)?"bottom":void 0,s=i.leftArray.find(i=>i.portid===t.fromPort)||i.rightArray.find(i=>i.portid===t.fromPort)||i.topArray.find(i=>i.portid===t.fromPort)||i.bottomArray.find(i=>i.portid===t.fromPort),h=e.leftArray.find(i=>i.portid===t.toPort)||e.rightArray.find(i=>i.portid===t.toPort)||e.topArray.find(i=>i.portid===t.toPort)||e.bottomArray.find(i=>i.portid===t.toPort);if(!s||!h)return;const r=o(i,s),n=o(e,h),a=i.position.x+s.offsetX+s.width/2,c=i.position.y+s.offsetY+s.height/2,d=e.position.x+h.offsetX+h.width/2,l=e.position.y+h.offsetY+h.height/2;this.drawPolylineLink_new(this.ctx,a,c,d,l,r,n)}drawArrow(t,i,e,o){const s=10;this.ctx.save(),this.ctx.translate(t,i),this.ctx.rotate(e),this.ctx.beginPath(),this.ctx.moveTo(-10,-5),this.ctx.lineTo(0,0),this.ctx.lineTo(-10,5),this.ctx.strokeStyle=o,this.ctx.lineWidth=2,this.ctx.stroke(),this.ctx.restore()}drawTempConnectionToMouse(t,i,e){if(!t||!t.module||!t.module.position)return;const o=t.module.position.x+t.offsetX+t.width/2,s=t.module.position.y+t.offsetY+t.height/2;this.ctx.beginPath(),this.ctx.moveTo(o,s),this.ctx.lineTo(i,e);const h=this.snapPort?"#00ff00":"#ff0000";this.ctx.strokeStyle=h,this.ctx.lineWidth=this.snapPort?2:1,this.ctx.stroke();const r=Math.atan2(e-s,i-o);this.drawArrow(i,e,r,h)}findNearestPort(t,i){let e=null,o=this.snapDistance;for(const s of this.portRects){if(this.startPort&&s.port===this.startPort)continue;const h=s.x+s.width/2,r=s.y+s.height/2,n=Math.sqrt(Math.pow(t-h,2)+Math.pow(i-r,2));n<o&&(o=n,e=s)}return e}getCurrentState(){const t=void 0,i=void 0;return{modules:this.data.modules.map(t=>{const i=t=>({portid:t.portid,portcolor:t.portcolor,offsetX:t.offsetX,offsetY:t.offsetY,width:t.width,height:t.height});return{id:t.id,name:t.name,type:t.type,position:{...t.position},leftArray:t.leftArray?t.leftArray.map(i):[],rightArray:t.rightArray?t.rightArray.map(i):[],topArray:t.topArray?t.topArray.map(i):[],bottomArray:t.bottomArray?t.bottomArray.map(i):[]}}),connections:this.data.connections.map(t=>({from:t.from,to:t.to,fromPort:t.fromPort,toPort:t.toPort,points:t.points||[]}))}}}class Rectangle{constructor(t,i,e,o){this.x=t,this.y=i,this.width=e,this.height=o}contains(t,i){return t>=this.x&&t<=this.x+this.width&&i>=this.y&&i<=this.y+this.height}}return{Ploteeavis:Ploteeavis}},"function"==typeof define&&define.amd?define([],i):"object"==typeof module&&module.exports?module.exports=i():t.veheeavis=i()});
