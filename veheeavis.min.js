!function(t){"function"==typeof define&&define.amd?define(t):t()}((function(){"use strict";var t,e;t="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0,e=function(){class Ploteeavis{constructor(t){this.container=document.querySelector(t.container),this.data=t.data,this.scale=1,this.draggingModule=null,this.dragOffsetX=0,this.dragOffsetY=0,this.startPort=null,this.endPort=null,this.selectedModule=null,this.canvas=document.createElement("canvas"),this.container.appendChild(this.canvas),this.ctx=this.canvas.getContext("2d"),this.dpr=window.devicePixelRatio||1,this.canvas.style.width=this.container.clientWidth+"px",this.canvas.style.height=this.container.clientHeight+"px",this.canvas.width=this.container.clientWidth*this.dpr,this.canvas.height=this.container.clientHeight*this.dpr,this.ctx.scale(this.dpr,this.dpr),this.view={x:0,y:0,zoom:1},this.snapDistance=20,this.snapPort=null,this.contextMenu=this.createContextMenu(),this.container.appendChild(this.contextMenu),this.activeModule=null,this.validateData(this.data),this.addEventListeners(),this.render()}createContextMenu(){const t=document.createElement("div");t.style.cssText="\n      position: absolute;\n      background: white;\n      border: 1px solid #ccc;\n      padding: 5px 0;\n      box-shadow: 2px 2px 5px rgba(0,0,0,0.2);\n      display: none;\n      z-index: 1000;\n    ";const e=void 0;return["Copy","Delete","Add Top Port","Add Left Port","Add Bottom Port","Add Right Port"].forEach((e=>{const i=document.createElement("div");i.textContent=e,i.style.cssText="\n        padding: 5px 20px;\n        cursor: pointer;\n        &:hover { background: #f0f0f0; }\n      ",t.appendChild(i)})),t}render(){this.ctx.save(),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.portRects=[],this.ctx.translate(this.view.x*this.dpr,this.view.y*this.dpr),this.ctx.scale(this.view.zoom,this.view.zoom),this.data.modules.forEach((t=>{this.drawModule(t),this.drawPorts(t)})),this.data.modules.every((t=>t.leftArray&&t.rightArray&&t.topArray&&t.bottomArray))&&this.data.connections.forEach((t=>{this.drawConnection(t)})),this.startPort&&this.drawTempConnectionToMouse(this.startPort,this.mouseX,this.mouseY),this.ctx.restore()}drawPorts(t){const{x:e,y:i,width:s,height:o}=t.position,n=t.leftArray,h=o/(n.length+2),r=6,a=e-3;n.forEach(((s,o)=>{const n=i+(o+1)*h;this.ctx.fillStyle=`rgb(${100*s.portcolor}, 0, 0)`,this.ctx.fillRect(a,n,6,10),s.offsetX=a-e,s.offsetY=n-i,s.width=6,s.height=10;const r=new Rectangle(a,n,6,10);r.port=s,r.module=t,this.portRects.push(r)}));const c=t.rightArray,d=o/(c.length+2),l=6,f=e+s-3;c.forEach(((s,o)=>{const n=i+(o+1)*d;this.ctx.fillStyle=`rgb(${100*s.portcolor}, 0, 0)`,this.ctx.fillRect(f,n,6,10),s.offsetX=f-e,s.offsetY=n-i,s.width=6,s.height=10;const h=new Rectangle(f,n,6,10);h.port=s,h.module=t,this.portRects.push(h)}));const p=t.topArray,u=s/(p.length+2),x=6,y=i-3;p.forEach(((s,o)=>{const n=e+(o+1)*u;this.ctx.fillStyle=`rgb(${100*s.portcolor}, 0, 0)`,this.ctx.fillRect(n,y,10,6),s.offsetX=n-e,s.offsetY=y-i,s.width=10,s.height=6;const h=new Rectangle(n,y,10,6);h.port=s,h.module=t,this.portRects.push(h)}));const g=t.bottomArray,m=s/(g.length+2),w=6,v=i+o-3;g.forEach(((s,o)=>{const n=e+(o+1)*m;this.ctx.fillStyle=`rgb(${100*s.portcolor}, 0, 0)`,this.ctx.fillRect(n,v,10,6),s.offsetX=n-e,s.offsetY=v-i,s.width=10,s.height=6;const h=new Rectangle(n,v,10,6);h.port=s,h.module=t,this.portRects.push(h)}))}validateData(t){const e=t.modules.map((t=>t.name));t.connections.forEach((t=>{if(!e.includes(t.from)||!e.includes(t.to))throw new Error(`Invalid connection: ${t.from} -> ${t.to}`)}))}addEventListeners(){this.portRects=[],this.canvas.addEventListener("mousedown",(t=>{const e=this.getCanvasCoords(t.clientX,t.clientY),i=this.portRects.find((t=>t.contains(e.x,e.y)));i?(this.startPortRect=i,this.startPort=i.port,this.startPort.module=i.module):this.data.modules.forEach((t=>{const{x:i,y:s,width:o,height:n}=t.position;e.x>=i&&e.x<=i+o&&e.y>=s&&e.y<=s+n&&(this.selectedModule=t,this.draggingModule=t,this.dragOffsetX=e.x-i,this.dragOffsetY=e.y-s,this.render())}))})),this.canvas.addEventListener("mousemove",(t=>{const e=this.getCanvasCoords(t.clientX,t.clientY);this.mouseX=e.x,this.mouseY=e.y;const i=this.portRects.find((t=>t.contains(e.x,e.y)));if(this.canvas.style.cursor=i?"pointer":"",this.startPort){const t=this.findNearestPort(e.x,e.y);t?(this.snapPort=t,this.mouseX=t.x+t.width/2,this.mouseY=t.y+t.height/2):this.snapPort=null,this.render()}else this.draggingModule&&(this.draggingModule.position.x=e.x-this.dragOffsetX,this.draggingModule.position.y=e.y-this.dragOffsetY,this.updatePorts(this.draggingModule),this.render())})),this.canvas.addEventListener("mouseup",(t=>{if(this.startPort){if(this.snapPort){const t={from:this.startPortRect.module.name,to:this.snapPort.module.name,fromPort:this.startPort.portid,toPort:this.snapPort.port.portid};this.data.connections.push(t),this.drawConnection(t)}this.startPort=null,this.snapPort=null,this.render()}else this.draggingModule&&(this.draggingModule=null,this.render())})),this.canvas.addEventListener("wheel",(t=>{if(t.ctrlKey){t.preventDefault();const e=this.canvas.getBoundingClientRect(),i=(t.clientX-e.left)/this.dpr,s=(t.clientY-e.top)/this.dpr,o=this.view.zoom;this.view.zoom*=t.deltaY>0?.9:1.1,this.view.zoom=Math.max(.1,Math.min(this.view.zoom,5)),this.view.x-=(i-this.view.x)*(this.view.zoom/o-1),this.view.y-=(s-this.view.y)*(this.view.zoom/o-1),this.render()}})),this.canvas.addEventListener("contextmenu",(t=>{t.preventDefault();const e=this.getCanvasCoords(t.clientX,t.clientY),i=this.data.modules.find((t=>{const{x:i,y:s,width:o,height:n}=t.position;return e.x>=i&&e.x<=i+o&&e.y>=s&&e.y<=s+n}));if(i){this.activeModule=i;const t=this.contextMenu.offsetWidth,s=this.contextMenu.offsetHeight,o=window.innerWidth,n=window.innerHeight;let h=e.x,r=e.y;h+t>o&&(h=o-t),r+s>n&&(r=n-s),this.contextMenu.style.display="block",this.contextMenu.style.left=h+"px",this.contextMenu.style.top=r+"px"}})),this.contextMenu.addEventListener("click",(t=>{const e=void 0;switch(t.target.textContent){case"Copy":this.copyModule(this.activeModule);break;case"Delete":this.deleteModule(this.activeModule);break;case"Add Top Port":this.addPort(this.activeModule,"top");break;case"Add Left Port":this.addPort(this.activeModule,"left");break;case"Add Bottom Port":this.addPort(this.activeModule,"bottom");break;case"Add Right Port":this.addPort(this.activeModule,"right")}this.contextMenu.style.display="none",this.render()})),document.addEventListener("click",(()=>{this.contextMenu.style.display="none"}))}copyModule(t){const e=JSON.parse(JSON.stringify(t));e.name=t.name+"_copy",e.position={...t.position,x:t.position.x+50,y:t.position.y+50},this.data.modules.push(e)}deleteModule(t){const e=this.data.modules.indexOf(t);e>-1&&(this.data.modules.splice(e,1),this.data.connections=this.data.connections.filter((e=>e.from!==t.name&&e.to!==t.name)))}addPort(t,e){const i={portid:`${e}_${Date.now()}`,portcolor:1};switch(e){case"top":t.topArray.push(i);break;case"left":t.leftArray.push(i);break;case"bottom":t.bottomArray.push(i);break;case"right":t.rightArray.push(i)}}updatePorts(t){const{x:e,y:i,width:s,height:o}=t.position,n=t.leftArray,h=o/(n.length+2),r=6,a=e-3;n.forEach(((t,s)=>{const o=i+(s+1)*h;t.offsetX=a-e,t.offsetY=o-i}));const c=t.rightArray,d=o/(c.length+2),l=6,f=e+s-3;c.forEach(((t,s)=>{const o=i+(s+1)*d;t.offsetX=f-e,t.offsetY=o-i}));const p=t.topArray,u=s/(p.length+2),x=6,y=i-3;p.forEach(((t,s)=>{const o=e+(s+1)*u;t.offsetX=o-e,t.offsetY=y-i}));const g=t.bottomArray,m=s/(g.length+2),w=6,v=i+o-3;g.forEach(((t,s)=>{const o=e+(s+1)*m;t.offsetX=o-e,t.offsetY=v-i}))}getCanvasCoords(t,e){const i=this.canvas.getBoundingClientRect();return{x:(t-i.left-this.view.x)/this.view.zoom,y:(e-i.top-this.view.y)/this.view.zoom}}drawModule(t){const{x:e,y:i,width:s,height:o,color:n}=t.position;t!==this.selectedModule&&t!==this.draggingModule||(this.ctx.strokeStyle="rgba(179, 177, 177, 0.5)",this.ctx.lineWidth=4,this.ctx.strokeRect(e-4,i-4,s+8,o+8)),this.ctx.fillStyle=n,this.ctx.fillRect(e,i,s,o),this.ctx.strokeStyle="#000",this.ctx.lineWidth=2,this.ctx.strokeRect(e,i,s,o),this.ctx.shadowColor="rgba(0, 0, 0, 0.1)",this.ctx.shadowBlur=10,this.ctx.shadowOffsetX=5,this.ctx.shadowOffsetY=5,this.ctx.fillStyle="#000",this.ctx.font="12px Microsoft YaHei",this.ctx.fillText(t.name,e+10,i+20)}drawPolylineLink(t,e,i,s,o){t.beginPath(),t.moveTo(e,i),t.lineTo(e,i),t.lineTo(s,o),t.lineTo(s,o),t.strokeStyle="black",t.lineWidth=1,t.stroke()}drawPolylineLink_new(t,e,i,s,o,n,h){t.beginPath(),t.moveTo(e,i);const r=void 0;this.calculatePathPoints(e,i,s,o,n,h).forEach((e=>t.lineTo(e.x,e.y))),t.strokeStyle="black",t.lineWidth=1,t.stroke()}calculatePathPoints(t,e,i,s,o,n){const h=[{x:t,y:e}],r=20;switch(o){case"right":h.push({x:t+r,y:e});break;case"left":h.push({x:t-r,y:e});break;case"bottom":h.push({x:t,y:e+r});break;case"top":h.push({x:t,y:e-r})}const a=h[1];let c;switch(n){case"left":c={x:i-r,y:s};break;case"right":c={x:i+r,y:s};break;case"top":c={x:i,y:s-r};break;case"bottom":c={x:i,y:s+r}}return"left"===o||"right"===o?(h.push({x:a.x,y:c.y}),h.push(c)):(h.push({x:c.x,y:a.y}),h.push(c)),h.push({x:i,y:s}),h}drawConnection(t){const e=this.data.modules.find((e=>e.name===t.from)),i=this.data.modules.find((e=>e.name===t.to));if(!e||!i)return;const s=(t,e)=>t.leftArray.includes(e)?"left":t.rightArray.includes(e)?"right":t.topArray.includes(e)?"top":t.bottomArray.includes(e)?"bottom":void 0,o=e.leftArray.find((e=>e.portid===t.fromPort))||e.rightArray.find((e=>e.portid===t.fromPort))||e.topArray.find((e=>e.portid===t.fromPort))||e.bottomArray.find((e=>e.portid===t.fromPort)),n=i.leftArray.find((e=>e.portid===t.toPort))||i.rightArray.find((e=>e.portid===t.toPort))||i.topArray.find((e=>e.portid===t.toPort))||i.bottomArray.find((e=>e.portid===t.toPort));if(!o||!n)return;const h=s(e,o),r=s(i,n),a=e.position.x+o.offsetX+o.width/2,c=e.position.y+o.offsetY+o.height/2,d=i.position.x+n.offsetX+n.width/2,l=i.position.y+n.offsetY+n.height/2;this.drawPolylineLink_new(this.ctx,a,c,d,l,h,r)}drawArrow(t,e,i,s){const o=10;this.ctx.save(),this.ctx.translate(t,e),this.ctx.rotate(i),this.ctx.beginPath(),this.ctx.moveTo(-10,-5),this.ctx.lineTo(0,0),this.ctx.lineTo(-10,5),this.ctx.strokeStyle=s,this.ctx.lineWidth=2,this.ctx.stroke(),this.ctx.restore()}drawTempConnectionToMouse(t,e,i){if(!t||!t.module||!t.module.position)return;const s=t.module.position.x+t.offsetX+t.width/2,o=t.module.position.y+t.offsetY+t.height/2;this.ctx.beginPath(),this.ctx.moveTo(s,o),this.ctx.lineTo(e,i);const n=this.snapPort?"#00ff00":"#ff0000";this.ctx.strokeStyle=n,this.ctx.lineWidth=this.snapPort?2:1,this.ctx.stroke();const h=Math.atan2(i-o,e-s);this.drawArrow(e,i,h,n)}findNearestPort(t,e){let i=null,s=this.snapDistance;for(const o of this.portRects){if(this.startPort&&o.port===this.startPort)continue;const n=o.x+o.width/2,h=o.y+o.height/2,r=Math.sqrt(Math.pow(t-n,2)+Math.pow(e-h,2));r<s&&(s=r,i=o)}return i}}class Rectangle{constructor(t,e,i,s){this.x=t,this.y=e,this.width=i,this.height=s}contains(t,e){return t>=this.x&&t<=this.x+this.width&&e>=this.y&&e<=this.y+this.height}}return{Ploteeavis:Ploteeavis}},"function"==typeof define&&define.amd?define([],e):"object"==typeof module&&module.exports?module.exports=e():t.veheeavis=e()}));
