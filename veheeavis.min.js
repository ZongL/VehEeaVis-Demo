!function(t){"function"==typeof define&&define.amd?define(t):t()}((function(){"use strict";var t,i;t="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0,i=function(){class Ploteeavis{constructor(t){this.container=document.querySelector(t.container),this.data=t.data,this.scale=1,this.draggingModule=null,this.dragOffsetX=0,this.dragOffsetY=0,this.startPort=null,this.endPort=null,this.selectedModule=null,this.canvas=document.createElement("canvas"),this.container.appendChild(this.canvas),this.ctx=this.canvas.getContext("2d"),this.dpr=window.devicePixelRatio||1,this.canvas.style.width=this.container.clientWidth+"px",this.canvas.style.height=this.container.clientHeight+"px",this.canvas.width=this.container.clientWidth*this.dpr,this.canvas.height=this.container.clientHeight*this.dpr,this.ctx.scale(this.dpr,this.dpr),this.view={x:0,y:0,zoom:1},this.snapDistance=20,this.snapPort=null,this.validateData(this.data),this.addEventListeners(),this.render()}render(){this.ctx.save(),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.portRects=[],this.ctx.translate(this.view.x*this.dpr,this.view.y*this.dpr),this.ctx.scale(this.view.zoom,this.view.zoom),this.data.modules.forEach((t=>{this.drawModule(t),this.drawPorts(t)})),this.data.modules.every((t=>t.leftArray&&t.rightArray&&t.topArray&&t.bottomArray))&&this.data.connections.forEach((t=>{this.drawConnection(t)})),this.startPort&&this.drawTempConnectionToMouse(this.startPort,this.mouseX,this.mouseY),this.ctx.restore()}drawPorts(t){const{x:i,y:s,width:e,height:o}=t.position,h=t.leftArray,r=o/(h.length+2),n=6,a=i-3;h.forEach(((e,o)=>{const h=s+(o+1)*r;this.ctx.fillStyle=`rgb(${100*e.portcolor}, 0, 0)`,this.ctx.fillRect(a,h,6,10),e.offsetX=a-i,e.offsetY=h-s,e.width=6,e.height=10;const n=new Rectangle(a,h,6,10);n.port=e,n.module=t,this.portRects.push(n)}));const c=t.rightArray,d=o/(c.length+2),l=6,f=i+e-3;c.forEach(((e,o)=>{const h=s+(o+1)*d;this.ctx.fillStyle=`rgb(${100*e.portcolor}, 0, 0)`,this.ctx.fillRect(f,h,6,10),e.offsetX=f-i,e.offsetY=h-s,e.width=6,e.height=10;const r=new Rectangle(f,h,6,10);r.port=e,r.module=t,this.portRects.push(r)}));const p=t.topArray,u=e/(p.length+2),x=6,g=s-3;p.forEach(((e,o)=>{const h=i+(o+1)*u;this.ctx.fillStyle=`rgb(${100*e.portcolor}, 0, 0)`,this.ctx.fillRect(h,g,10,6),e.offsetX=h-i,e.offsetY=g-s,e.width=10,e.height=6;const r=new Rectangle(h,g,10,6);r.port=e,r.module=t,this.portRects.push(r)}));const y=t.bottomArray,m=e/(y.length+2),w=6,v=s+o-3;y.forEach(((e,o)=>{const h=i+(o+1)*m;this.ctx.fillStyle=`rgb(${100*e.portcolor}, 0, 0)`,this.ctx.fillRect(h,v,10,6),e.offsetX=h-i,e.offsetY=v-s,e.width=10,e.height=6;const r=new Rectangle(h,v,10,6);r.port=e,r.module=t,this.portRects.push(r)}))}validateData(t){const i=t.modules.map((t=>t.name));t.connections.forEach((t=>{if(!i.includes(t.from)||!i.includes(t.to))throw new Error(`Invalid connection: ${t.from} -> ${t.to}`)}))}addEventListeners(){this.portRects=[],this.canvas.addEventListener("mousedown",(t=>{const i=this.getCanvasCoords(t.clientX,t.clientY),s=this.portRects.find((t=>t.contains(i.x,i.y)));s?(this.startPortRect=s,this.startPort=s.port,this.startPort.module=s.module):this.data.modules.forEach((t=>{const{x:s,y:e,width:o,height:h}=t.position;i.x>=s&&i.x<=s+o&&i.y>=e&&i.y<=e+h&&(this.selectedModule=t,this.draggingModule=t,this.dragOffsetX=i.x-s,this.dragOffsetY=i.y-e,this.render())}))})),this.canvas.addEventListener("mousemove",(t=>{const i=this.getCanvasCoords(t.clientX,t.clientY);this.mouseX=i.x,this.mouseY=i.y;const s=this.portRects.find((t=>t.contains(i.x,i.y)));if(this.canvas.style.cursor=s?"pointer":"",this.startPort){const t=this.findNearestPort(i.x,i.y);t?(this.snapPort=t,this.mouseX=t.x+t.width/2,this.mouseY=t.y+t.height/2):this.snapPort=null,this.render()}else this.draggingModule&&(this.draggingModule.position.x=i.x-this.dragOffsetX,this.draggingModule.position.y=i.y-this.dragOffsetY,this.updatePorts(this.draggingModule),this.render())})),this.canvas.addEventListener("mouseup",(t=>{if(this.startPort){if(this.snapPort){const t={from:this.startPortRect.module.name,to:this.snapPort.module.name,fromPort:this.startPort.portid,toPort:this.snapPort.port.portid};this.data.connections.push(t),this.drawConnection(t)}this.startPort=null,this.snapPort=null,this.render()}else this.draggingModule&&(this.draggingModule=null,this.render())})),this.canvas.addEventListener("wheel",(t=>{if(t.ctrlKey){t.preventDefault();const i=this.canvas.getBoundingClientRect(),s=(t.clientX-i.left)/this.dpr,e=(t.clientY-i.top)/this.dpr,o=this.view.zoom;this.view.zoom*=t.deltaY>0?.9:1.1,this.view.zoom=Math.max(.1,Math.min(this.view.zoom,5)),this.view.x-=(s-this.view.x)*(this.view.zoom/o-1),this.view.y-=(e-this.view.y)*(this.view.zoom/o-1),this.render()}}))}updatePorts(t){const{x:i,y:s,width:e,height:o}=t.position,h=t.leftArray,r=o/(h.length+2),n=6,a=i-3;h.forEach(((t,e)=>{const o=s+(e+1)*r;t.offsetX=a-i,t.offsetY=o-s}));const c=t.rightArray,d=o/(c.length+2),l=6,f=i+e-3;c.forEach(((t,e)=>{const o=s+(e+1)*d;t.offsetX=f-i,t.offsetY=o-s}));const p=t.topArray,u=e/(p.length+2),x=6,g=s-3;p.forEach(((t,e)=>{const o=i+(e+1)*u;t.offsetX=o-i,t.offsetY=g-s}));const y=t.bottomArray,m=e/(y.length+2),w=6,v=s+o-3;y.forEach(((t,e)=>{const o=i+(e+1)*m;t.offsetX=o-i,t.offsetY=v-s}))}getCanvasCoords(t,i){const s=this.canvas.getBoundingClientRect();return{x:(t-s.left-this.view.x)/this.view.zoom,y:(i-s.top-this.view.y)/this.view.zoom}}drawModule(t){const{x:i,y:s,width:e,height:o,color:h}=t.position;t!==this.selectedModule&&t!==this.draggingModule||(this.ctx.strokeStyle="rgba(179, 177, 177, 0.5)",this.ctx.lineWidth=4,this.ctx.strokeRect(i-4,s-4,e+8,o+8)),this.ctx.fillStyle=h,this.ctx.fillRect(i,s,e,o),this.ctx.strokeStyle="#000",this.ctx.lineWidth=2,this.ctx.strokeRect(i,s,e,o),this.ctx.shadowColor="rgba(0, 0, 0, 0.1)",this.ctx.shadowBlur=10,this.ctx.shadowOffsetX=5,this.ctx.shadowOffsetY=5,this.ctx.fillStyle="#000",this.ctx.font="12px Microsoft YaHei",this.ctx.fillText(t.name,i+10,s+20)}drawPolylineLink(t,i,s,e,o){t.beginPath(),t.moveTo(i,s),t.lineTo(i,s),t.lineTo(e,o),t.lineTo(e,o),t.strokeStyle="black",t.lineWidth=1,t.stroke()}drawPolylineLink_new(t,i,s,e,o,h,r){t.beginPath(),t.moveTo(i,s);const n=void 0;this.calculatePathPoints(i,s,e,o,h,r).forEach((i=>t.lineTo(i.x,i.y))),t.strokeStyle="black",t.lineWidth=1,t.stroke()}calculatePathPoints(t,i,s,e,o,h){const r=[{x:t,y:i}],n=20;switch(o){case"right":r.push({x:t+n,y:i});break;case"left":r.push({x:t-n,y:i});break;case"bottom":r.push({x:t,y:i+n});break;case"top":r.push({x:t,y:i-n})}const a=r[1];let c;switch(h){case"left":c={x:s-n,y:e};break;case"right":c={x:s+n,y:e};break;case"top":c={x:s,y:e-n};break;case"bottom":c={x:s,y:e+n}}return"left"===o||"right"===o?(r.push({x:a.x,y:c.y}),r.push(c)):(r.push({x:c.x,y:a.y}),r.push(c)),r.push({x:s,y:e}),r}drawConnection(t){const i=this.data.modules.find((i=>i.name===t.from)),s=this.data.modules.find((i=>i.name===t.to));if(!i||!s)return;const e=(t,i)=>t.leftArray.includes(i)?"left":t.rightArray.includes(i)?"right":t.topArray.includes(i)?"top":t.bottomArray.includes(i)?"bottom":void 0,o=i.leftArray.find((i=>i.portid===t.fromPort))||i.rightArray.find((i=>i.portid===t.fromPort))||i.topArray.find((i=>i.portid===t.fromPort))||i.bottomArray.find((i=>i.portid===t.fromPort)),h=s.leftArray.find((i=>i.portid===t.toPort))||s.rightArray.find((i=>i.portid===t.toPort))||s.topArray.find((i=>i.portid===t.toPort))||s.bottomArray.find((i=>i.portid===t.toPort));if(!o||!h)return;const r=e(i,o),n=e(s,h),a=i.position.x+o.offsetX+o.width/2,c=i.position.y+o.offsetY+o.height/2,d=s.position.x+h.offsetX+h.width/2,l=s.position.y+h.offsetY+h.height/2;this.drawPolylineLink_new(this.ctx,a,c,d,l,r,n)}drawArrow(t,i,s,e){const o=10;this.ctx.save(),this.ctx.translate(t,i),this.ctx.rotate(s),this.ctx.beginPath(),this.ctx.moveTo(-10,-5),this.ctx.lineTo(0,0),this.ctx.lineTo(-10,5),this.ctx.strokeStyle=e,this.ctx.lineWidth=2,this.ctx.stroke(),this.ctx.restore()}drawTempConnectionToMouse(t,i,s){if(!t||!t.module||!t.module.position)return;const e=t.module.position.x+t.offsetX+t.width/2,o=t.module.position.y+t.offsetY+t.height/2;this.ctx.beginPath(),this.ctx.moveTo(e,o),this.ctx.lineTo(i,s);const h=this.snapPort?"#00ff00":"#ff0000";this.ctx.strokeStyle=h,this.ctx.lineWidth=this.snapPort?2:1,this.ctx.stroke();const r=Math.atan2(s-o,i-e);this.drawArrow(i,s,r,h)}findNearestPort(t,i){let s=null,e=this.snapDistance;for(const o of this.portRects){if(this.startPort&&o.port===this.startPort)continue;const h=o.x+o.width/2,r=o.y+o.height/2,n=Math.sqrt(Math.pow(t-h,2)+Math.pow(i-r,2));n<e&&(e=n,s=o)}return s}}class Rectangle{constructor(t,i,s,e){this.x=t,this.y=i,this.width=s,this.height=e}contains(t,i){return t>=this.x&&t<=this.x+this.width&&i>=this.y&&i<=this.y+this.height}}return{Ploteeavis:Ploteeavis}},"function"==typeof define&&define.amd?define([],i):"object"==typeof module&&module.exports?module.exports=i():t.veheeavis=i()}));
